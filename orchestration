#!/bin/bash

export var1; export var2

function check {
  [ $(docker network ls | grep macvlan | awk '{print $2}') ] && { 
    lantest="sim" 
  } || {
    lantest="nao"
    }
 
  [ "$lantest" = "nao" ] && {
    dialog --title "MACVLAN" --yesno "Deseja criar uma rede macvlan?" 6 40
    [ $? = 0 ] && {
    
    gateway0=$(route -n | grep 'UG[ \t]' | awk '{print $2}')
    rede0=$(ls /sys/class/net | grep enp) 
    
    ip a
    
    echo ""
    echo "#########################################"
    echo "# Configurações pré-carregadas!         #"
    echo "# Pressione ENTER ao acabar a consulta. #"
    echo "#########################################"
    echo ""
    
    read
    
    VALUE1="$gateway0/24"; VALUE2="$gateway0"; VALUE3="$rede0"

    VALUE0=$(dialog --ok-label "Criar" --title "Nova Rede Bridge" --form "Subnet = x.x.0.0/24" 10 40 0 \
"Subnet  :" 1 1 "$VALUE1" 1 10 20 0 \
"Gateway :" 2 1 "$VALUE2" 2 10 20 0 \
"Interfc :" 3 1 "$VALUE3" 3 10 20 0 \
3>&1 1>&2 2>&3 3>&- > /dev/tty)

    [ $? -ne 0 ] && exit
    var1=$(echo "$VALUE0" | sed -n 1p)
    var2=$(echo "$VALUE0" | sed -n 2p)
    var3=$(echo "$VALUE0" | sed -n 3p)
    
    [ -z "$var1" ] || [ -z "$var2" ] && {
      dialog --title "ERRO" --msgbox "Não deixe nenhum campo vazio!" 8 40
      check
    } || {
      sudo docker network create -d macvlan --subnet="$var1" --gateway="$var2" -o parent="$var3" macvlan
      start
      }

      } || {
        echo "ATENÇÃO: Não há macvlan para os containers!"
        sleep 3
        start
        }
      
    } || {
      start
      }

}

function start {
var0=$(dialog --title 'Docker Manager' --backtitle "Sistema Automatizado de Orquestração de Containers" --menu " " 0 0 0 \
A '01 PiHole' \
B '02 Dominio' \
C '03 UniFi' \
D '041 MySQL' \
E '042 NextCloud' \
F '05 Backup' \
G '06 SAMBA' \
H '07 AutoMigrate ADDC' \
I '08 AutoExport SAMBA' \
J '09 Pentest' \
K '10 CUPS' \
L '11 LAN Cache' \
M '12 MinhaReceita' \
N '13 RSnapShots' \
O '14 OracleDB XE' \
X 'Sair' 2>&1 > /dev/tty )

case "$var0" in
A) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/01-pihole | sudo bash ; start ;;
B) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/02-domain | sudo bash ; start ;;
C) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/03-unifi | sudo bash ; start ;;
D) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/04.1-mysql | sudo bash ; start ;;
E) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/04.2-nextcloud | sudo bash ; start ;;
F) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/05-backup | sudo bash ; start ;;
G) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/06-samba | sudo bash ; start ;;
H) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/07-AutoMigrateADDC.sh | sudo bash ; start ;;
I) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/08.1-AutoExport_Samba.sh | sudo bash ; start ;;
J) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/09-pentest | sudo bash ; start ;;
K) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/10-cups | sudo bash ; start ;;
L) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/11-lancache | sudo bash ; start ;;
M) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/12-minhareceita | sudo bash ; start ;;
N) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/13-rsnapshot | sudo bash ; start ;;
O) curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/14-oracle_xe | sudo bash ; start ;;
X) echo "Saindo..." && curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/docker | sudo bash && break ;;
esac
}

# Start
check
