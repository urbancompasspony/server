#!/bin/bash

#####################################################################################################
# Sistema Interativo de T√∫neis SSH
# Vers√£o simplificada - sempre customizada com exemplos de conex√£o
#####################################################################################################

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configura√ß√µes SSH
scpoptions="-o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/dev/null -o ServerAliveInterval=60 -o ServerAliveCountMax=5"

# Arquivo tempor√°rio para salvar configura√ß√µes
CONFIG_FILE="/tmp/ssh-tunnel-config-$$"

# Vari√°veis globais
tunel1_pid=""
tunel2_pid=""

#####################################################################################################
# FUN√á√ïES DE PERSIST√äNCIA
#####################################################################################################

save_config() {
    cat > "$CONFIG_FILE" << EOF
servidor1_full="$servidor1_full"
servidor2_full="$servidor2_full"
password_servidor2="$password_servidor2"
target_ip="$target_ip"
target_port="$target_port"
porta_local_tunel1="$porta_local_tunel1"
porta_local_service="$porta_local_service"
EOF
}

load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        source "$CONFIG_FILE"
        return 0
    fi
    return 1
}

#####################################################################################################
# FUN√á√ïES PRINCIPAIS
#####################################################################################################

print_header() {
    clear
    echo -e "${CYAN}================================================================${NC}"
    echo -e "${CYAN}           Sistema Interativo de T√∫neis SSH                     ${NC}"
    echo -e "${CYAN}================================================================${NC}"
    echo ""
}

cleanup() {
    echo ""
    echo -e "${YELLOW}Encerrando t√∫neis...${NC}"

    if [[ -n "$tunel1_pid" ]] && kill -0 $tunel1_pid 2>/dev/null; then
        kill $tunel1_pid 2>/dev/null
        echo -e "${GREEN}‚úì T√∫nel 1 encerrado${NC}"
    fi

    if [[ -n "$tunel2_pid" ]] && kill -0 $tunel2_pid 2>/dev/null; then
        kill $tunel2_pid 2>/dev/null
        echo -e "${GREEN}‚úì T√∫nel 2 encerrado${NC}"
    fi

    # Limpar arquivo tempor√°rio
    rm -f "$CONFIG_FILE"

    echo -e "${CYAN}Obrigado por usar o sistema de t√∫neis!${NC}"
    exit 0
}

get_user_input() {
    print_header

    # Tentar carregar configura√ß√£o anterior
    local config_loaded=false
    if load_config; then
        config_loaded=true
        echo -e "${YELLOW}üìÇ Configura√ß√£o anterior encontrada! Voc√™ pode reutilizar os valores ou alter√°-los.${NC}"
        echo ""
    fi

    echo -e "${BLUE}üìã CONFIGURA√á√ÉO DOS SERVIDORES${NC}"
    echo ""

    # Servidor 1 (Tailscale)
    echo -e "${YELLOW}1. Servidor Tailscale (com chaves SSH configuradas):${NC}"
    if $config_loaded && [[ -n "$servidor1_full" ]]; then
        echo -e "   Valor anterior: ${GREEN}$servidor1_full${NC}"
        read -p "   Digite usuario@servidor [$servidor1_full]: " input_servidor1
        servidor1_full="${input_servidor1:-$servidor1_full}"
    else
        read -p "   Digite usuario@servidor: " servidor1_full
    fi

    if [[ ! "$servidor1_full" =~ ^[^@]+@[^@]+$ ]]; then
        echo -e "${RED}‚ùå Formato inv√°lido! Use: usuario@servidor${NC}"
        echo -e "${YELLOW}Salvando dados preenchidos...${NC}"
        save_config
        sleep 2
        get_user_input
        return
    fi

    echo ""

    # Servidor 2 (pfSense/Gateway)
    echo -e "${YELLOW}2. Servidor pfSense/Gateway:${NC}"
    if $config_loaded && [[ -n "$servidor2_full" ]]; then
        echo -e "   Valor anterior: ${GREEN}$servidor2_full${NC}"
        read -p "   Digite usuario@IP [$servidor2_full]: " input_servidor2
        servidor2_full="${input_servidor2:-$servidor2_full}"
    else
        read -p "   Digite usuario@IP (ex: admin@192.168.1.1): " servidor2_full
    fi

    if [[ ! "$servidor2_full" =~ ^[^@]+@[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${RED}‚ùå Formato inv√°lido! Use: usuario@IP${NC}"
        echo -e "${YELLOW}Salvando dados preenchidos...${NC}"
        save_config
        sleep 2
        get_user_input
        return
    fi

    # Senha do servidor 2
    if $config_loaded && [[ -n "$password_servidor2" ]]; then
        echo -e "   Senha anterior: ${GREEN}[SALVA]${NC}"
        read -p "   Usar senha anterior? (s/N): " use_old_pass
        if [[ "$use_old_pass" =~ ^[Ss]$ ]]; then
            echo -e "   ${GREEN}‚úì Usando senha salva${NC}"
        else
            read -s -p "   Nova senha para $servidor2_full: " password_servidor2
            echo ""
        fi
    else
        read -s -p "   Senha do $servidor2_full: " password_servidor2
        echo ""
    fi
    echo ""

    # Servi√ßo alvo - Simplificado
    echo -e "${YELLOW}3. Servi√ßo de destino:${NC}"
    if $config_loaded && [[ -n "$target_ip" ]]; then
        echo -e "   IP anterior: ${GREEN}$target_ip${NC}"
        read -p "   IP do servi√ßo alvo [$target_ip]: " input_target_ip
        target_ip="${input_target_ip:-$target_ip}"
    else
        read -p "   IP do servi√ßo alvo: " target_ip
    fi

    if [[ ! "$target_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${RED}‚ùå IP inv√°lido!${NC}"
        echo -e "${YELLOW}Salvando dados preenchidos...${NC}"
        save_config
        sleep 2
        get_user_input
        return
    fi

    # Porta - sempre customizada
    if $config_loaded && [[ -n "$target_port" ]]; then
        echo -e "   Porta anterior: ${GREEN}$target_port${NC}"
        read -p "   Porta do servi√ßo [$target_port]: " input_target_port
        target_port="${input_target_port:-$target_port}"
    else
        read -p "   Porta do servi√ßo: " target_port
    fi

    if [[ ! "$target_port" =~ ^[0-9]+$ ]] || [ "$target_port" -lt 1 ] || [ "$target_port" -gt 65535 ]; then
        echo -e "${RED}‚ùå Porta inv√°lida! Use um n√∫mero entre 1 e 65535${NC}"
        echo -e "${YELLOW}Salvando dados preenchidos...${NC}"
        save_config
        sleep 2
        get_user_input
        return
    fi

    # Definir portas locais autom√°ticamente
    porta_local_tunel1=2221
    porta_local_service=$((8000 + target_port))

    # Se a porta calculada for muito alta, usa uma alternativa
    if [ $porta_local_service -gt 65535 ]; then
        porta_local_service=$((target_port + 1000))
        if [ $porta_local_service -gt 65535 ]; then
            porta_local_service=$((target_port - 1000))
        fi
    fi

    # Salvar configura√ß√£o completa
    save_config
}

show_summary() {
    echo ""
    echo -e "${CYAN}üìã RESUMO DA CONFIGURA√á√ÉO${NC}"
    echo -e "${CYAN}================================${NC}"
    echo -e "üñ•Ô∏è  Servidor Tailscale: ${GREEN}$servidor1_full${NC}"
    echo -e "üîß Servidor Gateway: ${GREEN}$servidor2_full${NC}"
    echo -e "üéØ Servi√ßo alvo: ${GREEN}$target_ip:$target_port${NC}"
    echo -e "üîó Porta local: ${GREEN}$porta_local_service${NC}"
    echo ""
    echo -e "${YELLOW}Op√ß√µes:${NC}"
    echo "   s) Confirmar e iniciar t√∫neis"
    echo "   e) Editar configura√ß√µes"
    echo "   q) Sair"
    echo ""
    read -p "Escolha (s/e/q): " confirm

    case "$confirm" in
        [Ss]*)
            return 0
            ;;
        [Ee]*)
            get_user_input
            show_summary
            return $?
            ;;
        [Qq]*)
            echo -e "${YELLOW}Saindo...${NC}"
            rm -f "$CONFIG_FILE"
            exit 0
            ;;
        *)
            echo -e "${YELLOW}Op√ß√£o inv√°lida, confirmando configura√ß√£o...${NC}"
            sleep 1
            return 0
            ;;
    esac
}

create_tunnels() {
    echo ""
    echo -e "${CYAN}üöÄ INICIANDO T√öNEIS${NC}"
    echo -e "${CYAN}====================${NC}"

    # Extrair informa√ß√µes
    servidor2_user=$(echo $servidor2_full | cut -d'@' -f1)
    servidor2_ip=$(echo $servidor2_full | cut -d'@' -f2)

    # Primeiro t√∫nel
    echo -e "${YELLOW}1. Criando primeiro t√∫nel...${NC}"
    echo "   $servidor1_full ‚Üí $servidor2_ip:22 (porta local: $porta_local_tunel1)"

    ssh $scpoptions "$servidor1_full" -N -L "$porta_local_tunel1:$servidor2_ip:22" &
    tunel1_pid=$!

    sleep 3

    if ! kill -0 $tunel1_pid 2>/dev/null; then
        echo -e "${RED}‚ùå ERRO: Primeiro t√∫nel falhou!${NC}"
        echo -e "${RED}   Verifique se as chaves SSH est√£o configuradas para $servidor1_full${NC}"
        echo ""
        echo -e "${YELLOW}Pressione Enter para voltar √†s configura√ß√µes...${NC}"
        read
        get_user_input
        show_summary
        create_tunnels
        return
    fi

    echo -e "${GREEN}   ‚úì Primeiro t√∫nel estabelecido (PID: $tunel1_pid)${NC}"

    # Segundo t√∫nel
    echo ""
    echo -e "${YELLOW}2. Criando segundo t√∫nel...${NC}"
    echo "   localhost:$porta_local_tunel1 ‚Üí $target_ip:$target_port (porta local: $porta_local_service)"

    sshpass -p "$password_servidor2" ssh $scpoptions "$servidor2_user@localhost" \
        -p "$porta_local_tunel1" \
        -N -L "$porta_local_service:$target_ip:$target_port" &
    tunel2_pid=$!

    sleep 3

    if ! kill -0 $tunel2_pid 2>/dev/null; then
        echo -e "${RED}‚ùå ERRO: Segundo t√∫nel falhou!${NC}"
        echo -e "${RED}   Verifique as credenciais do $servidor2_full${NC}"
        kill $tunel1_pid 2>/dev/null
        echo ""
        echo -e "${YELLOW}Pressione Enter para voltar √†s configura√ß√µes...${NC}"
        read
        get_user_input
        show_summary
        create_tunnels
        return
    fi

    echo -e "${GREEN}   ‚úì Segundo t√∫nel estabelecido (PID: $tunel2_pid)${NC}"
}

get_connection_examples() {
    local examples=""

    # Detectar tipo comum de servi√ßo baseado na porta
    case $target_port in
        22)   examples="ssh usuario@localhost -p $porta_local_service" ;;
        80)   examples="curl http://localhost:$porta_local_service\nou acesse no navegador: http://localhost:$porta_local_service" ;;
        443)  examples="curl -k https://localhost:$porta_local_service\nou acesse no navegador: https://localhost:$porta_local_service" ;;
        3389) examples="Conectar RDP: localhost:$porta_local_service\nUsu√°rio: [seu_usuario]\nSenha: [sua_senha]" ;;
        21)   examples="ftp localhost $porta_local_service" ;;
        23)   examples="telnet localhost $porta_local_service" ;;
        3306) examples="mysql -h localhost -P $porta_local_service -u [usuario] -p" ;;
        5432) examples="psql -h localhost -p $porta_local_service -U [usuario] [database]" ;;
        5900) examples="Conectar VNC: localhost:$porta_local_service" ;;
        8080) examples="curl http://localhost:$porta_local_service\nou acesse no navegador: http://localhost:$porta_local_service" ;;
        *)    examples="Conectar em: localhost:$porta_local_service\nUse o cliente apropriado para o servi√ßo na porta $target_port" ;;
    esac

    echo "$examples"
}

show_success() {
    echo ""
    echo -e "${GREEN}================================================================${NC}"
    echo -e "${GREEN}            üéâ T√öNEIS ESTABELECIDOS COM SUCESSO! üéâ            ${NC}"
    echo -e "${GREEN}================================================================${NC}"
    echo ""
    echo -e "${CYAN}üìä STATUS DOS T√öNEIS:${NC}"
    echo -e "   T√∫nel 1: ${GREEN}Ativo${NC} (PID: $tunel1_pid)"
    echo -e "   T√∫nel 2: ${GREEN}Ativo${NC} (PID: $tunel2_pid)"
    echo ""
    echo -e "${YELLOW}üéØ INFORMA√á√ïES DE CONEX√ÉO:${NC}"
    echo -e "${YELLOW}===============================${NC}"
    echo -e "   Destino original: ${CYAN}$target_ip:$target_port${NC}"
    echo -e "   Acesso local: ${GREEN}localhost:$porta_local_service${NC}"
    echo ""
    echo -e "${BLUE}üí° EXEMPLOS DE CONEX√ÉO:${NC}"
    echo -e "${BLUE}========================${NC}"
    local examples=$(get_connection_examples)
    echo -e "${GREEN}$examples${NC}"
    echo ""
    echo -e "${CYAN}üìÑ Configura√ß√£o salva em: ${CONFIG_FILE}${NC}"
    echo ""
    echo -e "${RED}‚ö†Ô∏è  IMPORTANTE:${NC}"
    echo -e "   ‚Ä¢ Mantenha este terminal aberto enquanto usar o servi√ßo"
    echo -e "   ‚Ä¢ Pressione ${YELLOW}Ctrl+C${NC} para encerrar os t√∫neis"
    echo -e "   ‚Ä¢ O sistema tentar√° reconectar automaticamente em caso de queda"
    echo -e "   ‚Ä¢ Execute novamente o script para reutilizar esta configura√ß√£o"
    echo ""
}

monitor_tunnels() {
    local reconnect_count=0

    while true; do
        # Verificar t√∫nel 1
        if ! kill -0 $tunel1_pid 2>/dev/null; then
            reconnect_count=$((reconnect_count + 1))
            echo -e "${RED}‚ùå T√∫nel 1 perdido! Tentativa de reconex√£o $reconnect_count...${NC}"

            ssh $scpoptions "$servidor1_full" -N -L "$porta_local_tunel1:$servidor2_ip:22" &
            tunel1_pid=$!
            sleep 3

            if kill -0 $tunel1_pid 2>/dev/null; then
                echo -e "${GREEN}‚úì T√∫nel 1 reconectado!${NC}"
            fi
        fi

        # Verificar t√∫nel 2
        if ! kill -0 $tunel2_pid 2>/dev/null; then
            reconnect_count=$((reconnect_count + 1))
            echo -e "${RED}‚ùå T√∫nel 2 perdido! Tentativa de reconex√£o $reconnect_count...${NC}"

            servidor2_user=$(echo $servidor2_full | cut -d'@' -f1)
            sshpass -p "$password_servidor2" ssh $scpoptions "$servidor2_user@localhost" \
                -p "$porta_local_tunel1" \
                -N -L "$porta_local_service:$target_ip:$target_port" &
            tunel2_pid=$!
            sleep 3

            if kill -0 $tunel2_pid 2>/dev/null; then
                echo -e "${GREEN}‚úì T√∫nel 2 reconectado!${NC}"
            fi
        fi

        # Mostrar status a cada 30 segundos se houver reconex√µes
        if [ $reconnect_count -gt 0 ] && [ $((reconnect_count % 3)) -eq 0 ]; then
            echo -e "${CYAN}‚ÑπÔ∏è  Status: T√∫neis ativos. Reconex√µes: $reconnect_count${NC}"
        fi

        sleep 10
    done
}

#####################################################################################################
# MAIN
#####################################################################################################

# Verificar depend√™ncias
if ! command -v sshpass &> /dev/null; then
    echo -e "${RED}‚ùå ERRO: sshpass n√£o est√° instalado!${NC}"
    echo -e "${YELLOW}   Ubuntu/Debian: sudo apt install sshpass${NC}"
    echo -e "${YELLOW}   CentOS/RHEL: sudo yum install sshpass${NC}"
    exit 1
fi

# Configurar trap para cleanup
trap cleanup SIGINT SIGTERM

# Executar fluxo principal
get_user_input
show_summary
create_tunnels
show_success
monitor_tunnels
