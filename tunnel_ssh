#!/bin/bash

#####################################################################################################
# Sistema Gerenciador de T√∫neis SSH Independentes
# Vers√£o Interativa - Controle independente de m√∫ltiplos t√∫neis
#####################################################################################################

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Configura√ß√µes SSH
scpoptions="-o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/dev/null -o ServerAliveInterval=60 -o ServerAliveCountMax=5"

# Arquivo de configura√ß√£o e estado
CONFIG_DIR="/tmp/ssh-tunnel-manager"
CONFIG_FILE="$CONFIG_DIR/config"
STATE_FILE="$CONFIG_DIR/state"
TUNNEL1_PID_FILE="$CONFIG_DIR/tunnel1.pid"
TUNNEL2_PID_FILE="$CONFIG_DIR/tunnel2.pid"

# Criar diret√≥rio se n√£o existir
mkdir -p "$CONFIG_DIR"

# Vari√°veis globais
servidor1_full=""
servidor2_full=""
password_servidor2=""
porta_local_tunel1="2221"
current_service_port=""
current_target_ip=""
current_target_port=""

#####################################################################################################
# FUN√á√ïES DE PERSIST√äNCIA
#####################################################################################################

save_config() {
    cat > "$CONFIG_FILE" << EOF
servidor1_full="$servidor1_full"
servidor2_full="$servidor2_full"
password_servidor2="$password_servidor2"
porta_local_tunel1="$porta_local_tunel1"
EOF
}

load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        source "$CONFIG_FILE"
        return 0
    fi
    return 1
}

save_tunnel1_pid() {
    echo "$1" > "$TUNNEL1_PID_FILE"
}

save_tunnel2_pid() {
    echo "$1" > "$TUNNEL2_PID_FILE"
}

get_tunnel1_pid() {
    if [[ -f "$TUNNEL1_PID_FILE" ]]; then
        cat "$TUNNEL1_PID_FILE"
    else
        echo ""
    fi
}

get_tunnel2_pid() {
    if [[ -f "$TUNNEL2_PID_FILE" ]]; then
        cat "$TUNNEL2_PID_FILE"
    else
        echo ""
    fi
}

save_service_config() {
    local service_id="$1"
    cat > "$CONFIG_DIR/service_$service_id" << EOF
target_ip="$2"
target_port="$3"
local_port="$4"
EOF
}

load_service_config() {
    local service_id="$1"
    if [[ -f "$CONFIG_DIR/service_$service_id" ]]; then
        source "$CONFIG_DIR/service_$service_id"
        return 0
    fi
    return 1
}

#####################################################################################################
# FUN√á√ïES DE INTERFACE
#####################################################################################################

print_header() {
    clear
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë        Sistema Gerenciador de T√∫neis SSH Independentes        ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

print_status() {
    echo -e "${YELLOW}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
    echo -e "${YELLOW}‚îÇ                     STATUS DOS T√öNEIS                      ‚îÇ${NC}"
    echo -e "${YELLOW}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"

    # Status do T√∫nel 1
    local tunnel1_pid=$(get_tunnel1_pid)
    if [[ -n "$tunnel1_pid" ]] && kill -0 "$tunnel1_pid" 2>/dev/null; then
        echo -e "  üì° T√∫nel 1 (Gateway): ${GREEN}‚óè ATIVO${NC} [PID: $tunnel1_pid]"
        if [[ -n "$servidor1_full" ]]; then
            echo -e "     ‚îî‚îÄ $servidor1_full ‚Üí Gateway SSH"
        fi
    else
        echo -e "  üì° T√∫nel 1 (Gateway): ${RED}‚óã INATIVO${NC}"
    fi

    # Status do T√∫nel 2
    local tunnel2_pid=$(get_tunnel2_pid)
    if [[ -n "$tunnel2_pid" ]] && kill -0 "$tunnel2_pid" 2>/dev/null; then
        echo -e "  üéØ T√∫nel 2 (Servi√ßo): ${GREEN}‚óè ATIVO${NC} [PID: $tunnel2_pid]"
        if [[ -n "$current_target_ip" ]]; then
            echo -e "     ‚îî‚îÄ localhost:$current_service_port ‚Üí $current_target_ip:$current_target_port"
        fi
    else
        echo -e "  üéØ T√∫nel 2 (Servi√ßo): ${RED}‚óã INATIVO${NC}"
    fi
    echo ""
}

show_main_menu() {
    print_header
    print_status

    echo -e "${BLUE}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
    echo -e "${BLUE}‚îÇ                      MENU PRINCIPAL                        ‚îÇ${NC}"
    echo -e "${BLUE}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
    echo ""
    echo -e "  ${CYAN}[1]${NC} üîß Configurar/Iniciar T√∫nel 1 (Gateway)"
    echo -e "  ${CYAN}[2]${NC} üéØ Configurar/Iniciar T√∫nel 2 (Servi√ßo)"
    echo -e "  ${CYAN}[3]${NC} üîÑ Trocar servi√ßo do T√∫nel 2 (mant√©m T√∫nel 1)"
    echo -e "  ${CYAN}[4]${NC} üìä Monitorar t√∫neis ativos"
    echo -e "  ${CYAN}[5]${NC} üõë Parar T√∫nel 1"
    echo -e "  ${CYAN}[6]${NC} üõë Parar T√∫nel 2"
    echo -e "  ${CYAN}[7]${NC} üîÑ Reiniciar todos os t√∫neis"
    echo -e "  ${CYAN}[8]${NC} üìã Ver configura√ß√µes salvas"
    echo -e "  ${CYAN}[9]${NC} üóëÔ∏è  Limpar todas as configura√ß√µes"
    echo -e "  ${CYAN}[0]${NC} ‚ùå Sair"
    echo ""
    echo -e "${YELLOW}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
    read -p "Escolha uma op√ß√£o: " choice

    case $choice in
        1) setup_tunnel1 ;;
        2) setup_tunnel2 ;;
        3) switch_service ;;
        4) monitor_tunnels ;;
        5) stop_tunnel1 ;;
        6) stop_tunnel2 ;;
        7) restart_all ;;
        8) show_configs ;;
        9) clear_all ;;
        0) cleanup_and_exit ;;
        *) echo -e "${RED}Op√ß√£o inv√°lida!${NC}"; sleep 1 ;;
    esac
}

#####################################################################################################
# FUN√á√ïES DO T√öNEL 1
#####################################################################################################

setup_tunnel1() {
    print_header
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${CYAN}              CONFIGURA√á√ÉO DO T√öNEL 1 (GATEWAY)              ${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""

    # Verificar se j√° est√° rodando
    local tunnel1_pid=$(get_tunnel1_pid)
    if [[ -n "$tunnel1_pid" ]] && kill -0 "$tunnel1_pid" 2>/dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  T√∫nel 1 j√° est√° ativo!${NC}"
        echo ""
        echo "  [1] Reconfigurar (ir√° parar o t√∫nel atual)"
        echo "  [2] Voltar ao menu"
        read -p "Escolha: " choice
        if [[ "$choice" != "1" ]]; then
            return
        fi
        stop_tunnel1
    fi

    # Carregar configura√ß√£o se existir
    if load_config && [[ -n "$servidor1_full" ]]; then
        echo -e "${GREEN}üìÇ Configura√ß√£o anterior encontrada:${NC}"
        echo -e "   Servidor: $servidor1_full"
        echo -e "   Gateway: $servidor2_full"
        echo ""
        echo "  [1] Usar configura√ß√£o existente"
        echo "  [2] Nova configura√ß√£o"
        read -p "Escolha: " use_existing

        if [[ "$use_existing" == "1" ]]; then
            start_tunnel1
            return
        fi
    fi

    # Nova configura√ß√£o
    echo -e "${YELLOW}Digite as informa√ß√µes do servidor Tailscale:${NC}"
    read -p "Usuario@Servidor: " servidor1_full

    if [[ ! "$servidor1_full" =~ ^[^@]+@[^@]+$ ]]; then
        echo -e "${RED}‚ùå Formato inv√°lido! Use: usuario@servidor${NC}"
        sleep 2
        return
    fi

    echo ""
    echo -e "${YELLOW}Digite as informa√ß√µes do Gateway/pfSense:${NC}"
    read -p "Usuario@IP: " servidor2_full

    if [[ ! "$servidor2_full" =~ ^[^@]+@[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${RED}‚ùå Formato inv√°lido! Use: usuario@IP${NC}"
        sleep 2
        return
    fi

    read -s -p "Senha do Gateway: " password_servidor2
    echo ""

    # Salvar e iniciar
    save_config
    start_tunnel1
}

start_tunnel1() {
    echo ""
    echo -e "${YELLOW}üöÄ Iniciando T√∫nel 1...${NC}"

    local servidor2_ip=$(echo $servidor2_full | cut -d'@' -f2)

    ssh $scpoptions "$servidor1_full" -N -L "$porta_local_tunel1:$servidor2_ip:22" &
    local pid=$!

    sleep 3

    if kill -0 $pid 2>/dev/null; then
        save_tunnel1_pid $pid
        echo -e "${GREEN}‚úÖ T√∫nel 1 estabelecido com sucesso! [PID: $pid]${NC}"
        echo -e "${CYAN}   Gateway SSH dispon√≠vel em: localhost:$porta_local_tunel1${NC}"
    else
        echo -e "${RED}‚ùå Falha ao estabelecer T√∫nel 1${NC}"
        echo -e "${YELLOW}   Verifique as chaves SSH para $servidor1_full${NC}"
    fi

    echo ""
    read -p "Pressione Enter para continuar..."
}

stop_tunnel1() {
    local tunnel1_pid=$(get_tunnel1_pid)
    if [[ -n "$tunnel1_pid" ]] && kill -0 "$tunnel1_pid" 2>/dev/null; then
        kill "$tunnel1_pid"
        rm -f "$TUNNEL1_PID_FILE"
        echo -e "${GREEN}‚úÖ T√∫nel 1 parado${NC}"

        # Parar T√∫nel 2 tamb√©m se estiver ativo
        local tunnel2_pid=$(get_tunnel2_pid)
        if [[ -n "$tunnel2_pid" ]] && kill -0 "$tunnel2_pid" 2>/dev/null; then
            echo -e "${YELLOW}‚ö†Ô∏è  Parando T√∫nel 2 (dependente do T√∫nel 1)...${NC}"
            stop_tunnel2
        fi
    else
        echo -e "${YELLOW}T√∫nel 1 n√£o est√° ativo${NC}"
    fi
}

#####################################################################################################
# FUN√á√ïES DO T√öNEL 2
#####################################################################################################

setup_tunnel2() {
    print_header
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${CYAN}              CONFIGURA√á√ÉO DO T√öNEL 2 (SERVI√áO)              ${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""

    # Verificar se T√∫nel 1 est√° ativo
    local tunnel1_pid=$(get_tunnel1_pid)
    if [[ -z "$tunnel1_pid" ]] || ! kill -0 "$tunnel1_pid" 2>/dev/null; then
        echo -e "${RED}‚ùå ERRO: T√∫nel 1 n√£o est√° ativo!${NC}"
        echo -e "${YELLOW}   √â necess√°rio estabelecer o T√∫nel 1 primeiro.${NC}"
        echo ""
        read -p "Deseja configurar o T√∫nel 1 agora? (s/n): " setup_t1
        if [[ "$setup_t1" =~ ^[Ss]$ ]]; then
            setup_tunnel1
        fi
        return
    fi

    # Verificar se j√° est√° rodando
    local tunnel2_pid=$(get_tunnel2_pid)
    if [[ -n "$tunnel2_pid" ]] && kill -0 "$tunnel2_pid" 2>/dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  T√∫nel 2 j√° est√° ativo!${NC}"
        echo -e "   Conectado a: $current_target_ip:$current_target_port"
        echo ""
        echo "  [1] Parar e reconfigurar"
        echo "  [2] Voltar ao menu"
        read -p "Escolha: " choice
        if [[ "$choice" != "1" ]]; then
            return
        fi
        stop_tunnel2
    fi

    configure_service
}

configure_service() {
    echo ""
    echo -e "${YELLOW}Configure o servi√ßo de destino:${NC}"
    read -p "IP do servi√ßo: " target_ip

    if [[ ! "$target_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${RED}‚ùå IP inv√°lido!${NC}"
        sleep 2
        return
    fi

    read -p "Porta do servi√ßo: " target_port

    if [[ ! "$target_port" =~ ^[0-9]+$ ]] || [ "$target_port" -lt 1 ] || [ "$target_port" -gt 65535 ]; then
        echo -e "${RED}‚ùå Porta inv√°lida!${NC}"
        sleep 2
        return
    fi

    # Calcular porta local
    local local_port=$((8000 + target_port))
    if [ $local_port -gt 65535 ]; then
        local_port=$((target_port + 1000))
        if [ $local_port -gt 65535 ]; then
            local_port=$((9000 + (target_port % 1000)))
        fi
    fi

    read -p "Porta local [$local_port]: " custom_port
    if [[ -n "$custom_port" ]]; then
        local_port=$custom_port
    fi

    # Salvar e iniciar
    current_target_ip="$target_ip"
    current_target_port="$target_port"
    current_service_port="$local_port"

    # Gerar ID √∫nico para o servi√ßo
    local service_id=$(date +%s)
    save_service_config "$service_id" "$target_ip" "$target_port" "$local_port"

    start_tunnel2
}

start_tunnel2() {
    echo ""
    echo -e "${YELLOW}üöÄ Iniciando T√∫nel 2...${NC}"

    if ! load_config; then
        echo -e "${RED}‚ùå Configura√ß√£o do Gateway n√£o encontrada!${NC}"
        return
    fi

    local servidor2_user=$(echo $servidor2_full | cut -d'@' -f1)

    sshpass -p "$password_servidor2" ssh $scpoptions "$servidor2_user@localhost" \
        -p "$porta_local_tunel1" \
        -N -L "$current_service_port:$current_target_ip:$current_target_port" &
    local pid=$!

    sleep 3

    if kill -0 $pid 2>/dev/null; then
        save_tunnel2_pid $pid
        echo -e "${GREEN}‚úÖ T√∫nel 2 estabelecido com sucesso! [PID: $pid]${NC}"
        echo ""
        show_connection_info
    else
        echo -e "${RED}‚ùå Falha ao estabelecer T√∫nel 2${NC}"
        echo -e "${YELLOW}   Verifique as credenciais do Gateway${NC}"
    fi

    echo ""
    read -p "Pressione Enter para continuar..."
}

stop_tunnel2() {
    local tunnel2_pid=$(get_tunnel2_pid)
    if [[ -n "$tunnel2_pid" ]] && kill -0 "$tunnel2_pid" 2>/dev/null; then
        kill "$tunnel2_pid"
        rm -f "$TUNNEL2_PID_FILE"
        echo -e "${GREEN}‚úÖ T√∫nel 2 parado${NC}"
    else
        echo -e "${YELLOW}T√∫nel 2 n√£o est√° ativo${NC}"
    fi
}

switch_service() {
    print_header
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${CYAN}                    TROCAR SERVI√áO DO T√öNEL 2                ${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""

    # Verificar se T√∫nel 1 est√° ativo
    local tunnel1_pid=$(get_tunnel1_pid)
    if [[ -z "$tunnel1_pid" ]] || ! kill -0 "$tunnel1_pid" 2>/dev/null; then
        echo -e "${RED}‚ùå T√∫nel 1 n√£o est√° ativo!${NC}"
        echo -e "${YELLOW}   √â necess√°rio que o T√∫nel 1 esteja ativo.${NC}"
        echo ""
        read -p "Pressione Enter para voltar..."
        return
    fi

    echo -e "${GREEN}‚úÖ T√∫nel 1 est√° ativo - Gateway dispon√≠vel${NC}"
    echo ""

    # Parar T√∫nel 2 se estiver ativo
    local tunnel2_pid=$(get_tunnel2_pid)
    if [[ -n "$tunnel2_pid" ]] && kill -0 "$tunnel2_pid" 2>/dev/null; then
        echo -e "${YELLOW}Parando T√∫nel 2 atual...${NC}"
        stop_tunnel2
        echo ""
    fi

    echo -e "${CYAN}Configure o novo servi√ßo:${NC}"
    configure_service
}

#####################################################################################################
# FUN√á√ïES DE MONITORAMENTO
#####################################################################################################

monitor_tunnels() {
    print_header
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${CYAN}                    MONITORAMENTO DOS T√öNEIS                 ${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${YELLOW}Pressione Ctrl+C para voltar ao menu${NC}"
    echo ""

    # Configurar trap local para esta fun√ß√£o
    trap 'echo ""; echo -e "${CYAN}Voltando ao menu...${NC}"; sleep 1; return' SIGINT

    while true; do
        echo -e "\r\033[K${CYAN}[$(date '+%H:%M:%S')]${NC} Verificando status..."

        local tunnel1_pid=$(get_tunnel1_pid)
        local tunnel2_pid=$(get_tunnel2_pid)

        # Status T√∫nel 1
        if [[ -n "$tunnel1_pid" ]] && kill -0 "$tunnel1_pid" 2>/dev/null; then
            echo -e "\r\033[K${GREEN}‚óè T√∫nel 1:${NC} Ativo [PID: $tunnel1_pid]"
        else
            echo -e "\r\033[K${RED}‚óã T√∫nel 1:${NC} Inativo"
        fi

        # Status T√∫nel 2
        if [[ -n "$tunnel2_pid" ]] && kill -0 "$tunnel2_pid" 2>/dev/null; then
            echo -e "${GREEN}‚óè T√∫nel 2:${NC} Ativo [PID: $tunnel2_pid] ‚Üí $current_target_ip:$current_target_port"
        else
            echo -e "${RED}‚óã T√∫nel 2:${NC} Inativo"
        fi

        sleep 5
        echo -e "\033[2A"  # Move cursor 2 linhas para cima
    done

    # Restaurar trap padr√£o ao sair
    trap - SIGINT
}

#####################################################################################################
# FUN√á√ïES AUXILIARES
#####################################################################################################

show_connection_info() {
    echo -e "${MAGENTA}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${MAGENTA}‚ïë                   INFORMA√á√ïES DE CONEX√ÉO                  ‚ïë${NC}"
    echo -e "${MAGENTA}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "  üéØ Servi√ßo original: ${CYAN}$current_target_ip:$current_target_port${NC}"
    echo -e "  üîó Acesso local: ${GREEN}localhost:$current_service_port${NC}"
    echo ""

    # Exemplos baseados na porta
    echo -e "${YELLOW}Exemplos de conex√£o:${NC}"
    case $current_target_port in
        22)   echo "  ssh usuario@localhost -p $current_service_port" ;;
        80)   echo "  curl http://localhost:$current_service_port" ;;
        443)  echo "  curl -k https://localhost:$current_service_port" ;;
        3389) echo "  RDP: localhost:$current_service_port" ;;
        3306) echo "  mysql -h localhost -P $current_service_port -u usuario -p" ;;
        5432) echo "  psql -h localhost -p $current_service_port -U usuario" ;;
        *)    echo "  Conectar em: localhost:$current_service_port" ;;
    esac
}

show_configs() {
    print_header
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${CYAN}                    CONFIGURA√á√ïES SALVAS                     ${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""

    if load_config; then
        echo -e "${GREEN}Configura√ß√£o do Gateway:${NC}"
        echo -e "  Servidor Tailscale: $servidor1_full"
        echo -e "  Gateway/pfSense: $servidor2_full"
        echo -e "  Porta local SSH: $porta_local_tunel1"
    else
        echo -e "${YELLOW}Nenhuma configura√ß√£o de Gateway salva${NC}"
    fi

    echo ""

    # Listar servi√ßos salvos
    local services=$(ls -1 "$CONFIG_DIR"/service_* 2>/dev/null)
    if [[ -n "$services" ]]; then
        echo -e "${GREEN}Servi√ßos configurados:${NC}"
        for service_file in $services; do
            source "$service_file"
            local service_name=$(basename "$service_file")
            echo -e "  ‚Ä¢ $target_ip:$target_port ‚Üí localhost:$local_port"
        done
    else
        echo -e "${YELLOW}Nenhum servi√ßo configurado${NC}"
    fi

    echo ""
    read -p "Pressione Enter para continuar..."
}

restart_all() {
    echo -e "${YELLOW}Reiniciando todos os t√∫neis...${NC}"

    # Parar tudo
    stop_tunnel2
    stop_tunnel1

    sleep 2

    # Reiniciar se houver configura√ß√£o
    if load_config && [[ -n "$servidor1_full" ]]; then
        echo -e "${CYAN}Reiniciando T√∫nel 1...${NC}"
        start_tunnel1

        if [[ -n "$current_target_ip" ]]; then
            sleep 2
            echo -e "${CYAN}Reiniciando T√∫nel 2...${NC}"
            start_tunnel2
        fi
    else
        echo -e "${YELLOW}Nenhuma configura√ß√£o salva para reiniciar${NC}"
    fi

    echo ""
    read -p "Pressione Enter para continuar..."
}

clear_all() {
    echo -e "${RED}‚ö†Ô∏è  ATEN√á√ÉO: Isso ir√°:${NC}"
    echo "  ‚Ä¢ Parar todos os t√∫neis ativos"
    echo "  ‚Ä¢ Apagar todas as configura√ß√µes salvas"
    echo ""
    read -p "Tem certeza? (s/n): " confirm

    if [[ "$confirm" =~ ^[Ss]$ ]]; then
        stop_tunnel2
        stop_tunnel1
        rm -rf "$CONFIG_DIR"
        mkdir -p "$CONFIG_DIR"
        echo -e "${GREEN}‚úÖ Todas as configura√ß√µes foram limpas${NC}"
    else
        echo -e "${YELLOW}Opera√ß√£o cancelada${NC}"
    fi

    sleep 2
}

cleanup_and_exit() {
    echo ""
    echo -e "${YELLOW}Encerrando...${NC}"

    echo "  [1] Manter t√∫neis ativos em background"
    echo "  [2] Parar todos os t√∫neis e sair"
    echo "  [3] Cancelar"
    read -p "Escolha: " exit_choice

    case $exit_choice in
        1)
            echo -e "${GREEN}‚úÖ T√∫neis mantidos em background${NC}"
            echo -e "${CYAN}   Execute o script novamente para gerenciar${NC}"
            exit 0
            ;;
        2)
            stop_tunnel2
            stop_tunnel1
            echo -e "${GREEN}‚úÖ Todos os t√∫neis foram parados${NC}"
            exit 0
            ;;
        *)
            return
            ;;
    esac
}

#####################################################################################################
# MAIN
#####################################################################################################

# Verificar depend√™ncias
if ! command -v sshpass &> /dev/null; then
    echo -e "${RED}‚ùå ERRO: sshpass n√£o est√° instalado!${NC}"
    echo -e "${YELLOW}   Ubuntu/Debian: sudo apt install sshpass${NC}"
    echo -e "${YELLOW}   CentOS/RHEL: sudo yum install sshpass${NC}"
    exit 1
fi

# N√£o usar trap global - deixar cada fun√ß√£o gerenciar seu pr√≥prio trap

# Loop principal
while true; do
    show_main_menu
done
