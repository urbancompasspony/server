#!/bin/bash

# # # # # # # # # # #
# SRV MGR Menu v0.1 #
# # # # # # # # # # # 

# For Ubuntu!
export pty=True
export NEEDRESTART_MODE=a
export DEBIAN_FRONTEND=noninteractive

# Hash
hash1="68b329da9893e34099c7d8ad5cb9c940"

# Versão:
version="v1.0"

# ------------------------------------------------------------------------------

# PASSWORD
function init {
password=$(dialog --backtitle "Server Manager $version" --title " " --insecure --passwordbox "Digite a senha!" 0 0 2>&1 > /dev/tty)
hash0=$(echo "$password" | md5sum | awk '{print $1}')
  [ -z "$password" ] && {
    clear
    echo "É necessário digitar uma senha para continuar. Saindo..."
  } || {
    [ "$hash0" = "$hash1" ] && {
      start
    } || {
      echo "Senha incorreta. Saindo..."
      }
  }
}

hash1="fe5dfdd991450623c39efc7705e47ad5"

function start {
var0=$(dialog --title ' ' --backtitle "Bem-Vindo ao Server Manager $version!" --menu " " 0 0 0 \
A 'Linite' \
B 'Install .Bashrc' \
C 'DWAgent [x86]' \
D 'DWAgent [ARM]' \
E 'AD Domain' \
F 'Desktop' \
G 'Orchestra' \
H 'Config & Tools' \
I 'Reboot' \
J 'Shutdown' \
X 'Sair' 2>&1 > /dev/tty )

case "$var0" in

A) curl -sSL https://raw.githubusercontent.com/urbancompasspony/linite/main/linite | sudo bash ; start ;;
B) curl -sSL https://raw.githubusercontent.com/urbancompasspony/bashrc/main/install.sh | bash ; start ;;
C) wget https://www.dwservice.net/download/dwagent_x86.sh -O /home/$USER/dwagent_x86.sh ; start ;;
D) wget https://www.dwservice.net/download/dwagent_generic.sh -O /home/$USER/dwagent_generic.sh ; start ;;
E) domainlocal01 ; start ;;
F) clear ; echo "Digite startx para entrar no modo Desktop!" ; sleep 5 ;;
G) curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/orchestration | bash ; start ;;
H) curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/tools | sudo bash ; start ;;
I) reb00t ;;
J) shutd0 ;;
X) exit ;;
esac
}

function domainlocal01 {
  [ $(which docker 2>/dev/null) ] && {
    docker ps -a | grep dominio 1> /dev/null && {
      docker exec dominio bash
    } || {
      domainlocal02
    }
  } || {
    domainlocal02
  }
}

function domainlocal02 {
sambastatus=$(ps aux | grep "domain" | grep -v grep 1> /dev/null && echo "Executando" || echo "Parado")
  [ "$sambastatus" = "Executando" ] && {
    curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/domain | sudo bash
  } || {
    dialog --cr-wrap --title 'Atenção!' --backtitle "$bktitle" --msgbox "Nenhum Controlador de Domínio localizado." 8 40
    }
}

hash1="e4439267203fb5277d347e6cd6e440b5"

function reb00t {
bbalance=$(ps aux | grep "btrfs balance start" | grep -v grep 1> /dev/null && echo "Executando" || echo "Parado")
rrsnap=$(ps aux | grep "rsnapshot" | grep -v grep 1> /dev/null && echo "Executando" || echo "Parado")
rsync1=$(ps aux | grep "rsync" | grep -v grep 1> /dev/null && echo "Executando" || echo "Parado")
cp1=$(ps u | grep "cp" | grep -v grep 1> /dev/null && echo "Executando" || echo "Parado")
datetime=$(date +"%d/%m %H:%M")
[ "$bbalance" = "Executando" ] || [ "$rrsnap" = "Executando" ] || [ "$rsync1" = "Executando" ] || [ "$cp1" = "Executando" ] && {
  dialog --cr-wrap --title 'ERRO AO REINICIAR' --backtitle "$bktitle" --msgbox "Reinício bloqueado! \n
Favor verificar o Status do Sistema ou tente novamente mais tarde." 0 0
} || {
  dialog --title 'Reiniciar' --backtitle "$bktitle" --yesno 'Deseja reiniciar este sistema?' 0 0
  [ $? = 0 ] && {
    [ "$report" = "1" ] && {
      dialog --title 'Relatório' --yesno "Deseja enviar um relatório por e-mail sobre este reinício?" 8 40
      [ $? = 0 ] && {
        menu08 "$Recado $Recado5 $datetime $Mensagem"
      } || {
        echo "a" > /dev/null
        }
    }
  sudo reboot
  }
}
start
}

hash1="576200e78f0ab25b437dc7372ae920d9"

function shutd0 {
rrsnap=$(ps aux | grep "rsnapshot" | grep -v grep 1> /dev/null && echo "Executando" || echo "Parado")
rsync1=$(ps aux | grep "rsync" | grep -v grep 1> /dev/null && echo "Executando" || echo "Parado")
bbalance=$(ps aux | grep "btrfs balance start" | grep -v grep 1> /dev/null && echo "Executando" || echo "Parado")
cp1=$(ps u | grep "cp" | grep -v grep 1> /dev/null && echo "Executando" || echo "Parado")
datetime=$(date +"%d/%m %H:%M")
[ "$bbalance" = "Executando" ] || [ "$rrsnap" = "Executando" ] || [ "$rsync1" = "Executando" ] || [ "$cp1" = "Executando" ] && {
  dialog --cr-wrap --title 'ERRO AO DESLIGAR' --backtitle 'ERRO AO TENTAR DESLIGAR.' --msgbox "Desligamento bloqueado! \n
Favor verificar o Status do Sistema ou tente novamente mais tarde." 0 0
} || {
  dialog --title 'Desligar' --backtitle 'D E S L I G A R' --yesno 'Deseja desligar este sistema?' 0 0
  [ $? = 0 ] && {
    [ "$report" = "1" ] && {
      dialog --title 'Relatório' --yesno "Deseja enviar um relatório por e-mail sobre este desligamento?" 8 40
      [ $? = 0 ] && {
        menu08 "$Recado $Recado6 $datetime $Mensagem"
      } || {
        echo "a" > /dev/null
        }
    }
  sudo shutdown -h now
  }
}
start
}

# ------------------------------------------------------------------------------

# Password
hash="e4439267203fb5277d347e6cd6e440b5"

[ "$EUID" -ne 0 ] || {
  echo "Não execute esse script como Root! Saindo..."
  exit
  }

# Checagem Obrigatória de Dependências:
[ -f /home/$USER/.installed ] || {
  [ -f /usr/bin/pacman ] && {
    sudo pacman -Syu dialog
    touch /home/$USER/.installed
    init
  } || {
    sudo apt update
    sudo apt install sshpass dialog curl lm-sensors arp-scan traceroute libatasmart-bin udpcast cifs-utils
    touch /home/$USER/.installed
    init
    }
} && {
  init
}

exit 1
