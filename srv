#!/bin/bash

# For Ubuntu!
export pty=True
export NEEDRESTART_MODE=a
export DEBIAN_FRONTEND=noninteractive

# Hash
hash1="68b329da9893e34099c7d8ad5cb9c940"
hash2="c357311ed3a47a08b423e1b42ec5c130"

# Versão:
version="v4"

# ------------------------------------------------------------------------------

# PASSWORD
function init {
password=$(dialog --backtitle "Server Manager $version" --title " " --insecure --passwordbox "Digite a senha!" 0 0 2>&1 > /dev/tty)
hash0=$(echo "$password" | md5sum | awk '{print $1}')
  [ $? -ne 0 ] && exit
  [ -z "$password" ] && {
      dialog --title "ERROR" --msgbox "É necessário digitar uma senha para continuar." 6 40
      clear
  } || {
    [ "$hash0" = "$hash1" ] && {
      start
    } || {
      [ "$hash0" = "$hash2" ] && {
        startocult
      } || {
        clear
        dialog --title "ERROR" --msgbox "Senha incorreta. \nTente novamente!" 6 30
        timeout=$((timeout+1)); sleep $timeout
        init
      }
    }
  }
}

hash1="fe5dfdd991450623c39efc7705e47ad5"

function start {
var0=$(dialog --title "SUPERVISOR" --backtitle "Bem-Vindo ao Server Manager $version!" --menu " " 0 0 0 \
1 'Orchestration' \
2 'Support & Help Desk' \
3 'Atualizar o .bashrc' \
4 'Auto-Relatorio' \
5 'BETA: Support Menus' \
6 'First Configuration' \
X 'Sair' 2>&1 > /dev/tty )
case "$var0" in
1) clear ; echo "Por favor, insira a senha do usuário $USER!" ; curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/orchestration | sudo bash ; start ;;
2) managers ; start ;;
3) curl -sSL https://raw.githubusercontent.com/urbancompasspony/bashrc/main/install.sh | bash ; start ;;
4) clear ; echo "Por favor, insira a senha do usuário $USER!" ; curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/auto_relatorio | tee /home/administrador/.autorelat ; chmod +x /home/administrador/.autorelat ; sudo bash /home/administrador/.autorelat ; start ;;
5) managers_testes ; start ;;
6) firstconfig ; start ;;
X) exit ;;
esac
}

function startocult {
  managers ; startocult
}

function managers {
var0=$(dialog --title 'Suporte & Help Desk' --backtitle "Suporte & Help Desk" --ok-label "Acessar" --cancel-label "Voltar" --menu " " 0 0 0 \
1 'Gerir Maquinas Virtuais' \
2 'Gerir Containers' \
3 'Gerir Active Directory' \
4 'Ferramentas & Utilidades' \
5 'Iniciar Area de Trabalho' \
6 'Urgencias & Emergencias' \
7 'Reiniciar Servidor' \
8 'Desligar Servidor' \
X 'Sair' 2>&1 > /dev/tty )
case "$var0" in
1) curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/vm_machine | bash ; managers ;;
2) curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/docker | bash ; managers ;;
3) docker exec -it dominio /root/.init ; managers ;;
4) clear ; echo "Por favor, insira a senha do usuário $USER!" ; curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/tools | sudo bash ; managers ;;
5) clear ; pstree -s $$ | grep sshd 1>&2 >/dev/null && echo "Voce esta tentando acessar o desktop remotamente. Use esse menu la na tela local do servidor!" || startx ; sleep 3 ; managers ;;
6) urgencies0 ; managers ;;
7) reb00t ; managers ;;
8) shutd0 ; managers ;;
X) exit ;;
esac
}

function urgencies0 {
var0=$(dialog --title ' ' --backtitle "Urgencias & Emergencias" --ok-label "Acessar" --cancel-label "Voltar" --menu " " 0 0 0 \
1 'Restauracao de Containers Locais' \
2 'Solucao de Problemas Comuns' \
3 'Reinstalar Servicos a partir da Nuvem' \
X 'Sair' 2>&1 > /dev/tty )
case "$var0" in
1) clear ; curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/Backup/03-AutoRestoreBKP | bash ; urgencies0 ;;
2) clear ; curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/solucao_de_problemas | bash ; urgencies0 ;;
3) clear ; curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/Backup/04-cloud | bash ; urgencies0 ;;
X) exit ;;
esac
}

function managers_testes {
var0=$(dialog --title ' ' --backtitle "Managers" --ok-label "Acessar" --cancel-label "Voltar" --menu " " 0 0 0 \
1 'Solucao de Problemas' \
2 'Restaurar Servicos (Nuvem)' \
X 'Sair' 2>&1 > /dev/tty )
case "$var0" in
1) clear ; curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/solucao_de_problemas | bash ; managers_testes ;;
2) clear ; curl -sSL https://raw.githubusercontent.com/urbancompasspony/docker/main/Backup/04-cloud | bash ; managers_testes ;;
X) exit ;;
esac
}

hash1="e4439267203fb5277d347e6cd6e440b5"

function reb00t {
  dialog --title 'Reiniciar' --backtitle "Reinicio" --yesno 'Deseja reiniciar este sistema?' 0 0
  [ $? = 0 ] && {
    sudo reboot
  } || {
    echo "." >/dev/null
  }
}

hash1="7c6126d9cc35fccb0c8a3a42147ea85f"

function shutd0 {
  dialog --title 'Desligar' --backtitle "Desligamento" --yesno 'Deseja desligar este sistema?' 0 0
  [ $? = 0 ] && {
    sudo shutdown -h now
  } || {
    echo "." >/dev/null
  }
}

function firstconfig {
var0=$(dialog --title ' ' --backtitle "Fiest Configuration!" --menu " " 0 0 0 \
1 'Linite' \
2 'AutoConfig pfSense (VM)' \
3 'DWAgent (ARM)' \
X '<' 2>&1 > /dev/tty )
case "$var0" in
1) curl -sSL https://raw.githubusercontent.com/urbancompasspony/linite/main/linite.menu | bash ; firstconfig ;;
2) curl -sSL https://raw.githubusercontent.com/urbancompasspony/server/main/auto_pfsense | sudo bash ; firstconfig ;;
3) dwgeneric0 ; firstconfig ;;
X) echo "." >/dev/null ;;
esac
}

function dwgeneric0 {
  wget https://www.dwservice.net/download/dwagent_generic.sh -O /home/administrador/dwagent_generic.sh
  chmod +x dwagent_generic.sh
  sudo bash dwagent_generic.sh
}

[ "$EUID" -ne 0 ] || {
  echo "Não execute esse script com sudo! Saindo..."
  exit
  }

init

exit 1
